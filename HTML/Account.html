<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Hesaplarım</title>
    <link rel="stylesheet" href="StyleAccount.css">
</head>
<style>
  body {
        background-image: url('../Src/Background.png');
        background-repeat: no-repeat;
        background-size: cover;        
        background-position: center;    
        background-attachment: fixed;   
    }
</style>
<body>
    <nav class="navbar">
      <a href="Dashboard.html" class="logo">
        <img src="../Src/Logo.png" alt="Green Bank Logo">
        Green Bank
      </a>
      <div class="nav-links">
        <a href="Account.html">Hesaplarım</a>
        <a href="Transfer.html">Para Aktar</a>
        <a href="Exchange.html">Döviz İşlemleri</a>
        <a href="">Canlı Destek</a>
        <a href="Settings.html">Ayarlar</a>
        <a href="Main.html">Çıkış Yap</a>
      </div>
    </nav>
    <div class="hesaplarim-container">
      <h2>Hesaplarım</h2>
      <table id="hesaplar-tablo">
        <tr>
          <th>Hesap Numarası</th>
          <th>Hesap Türü</th>
          <th>Bakiye</th>
        </tr>
      </table>
      <button id="hesap-olustur-btn">+ Hesap Oluştur</button>
      <div id="uyari-mesaj"></div>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", function() {
        const userId = localStorage.getItem('userId');
        if (!userId) {
            window.location.href = "Login.html";
            return;
        }

        function hesaplariYukle() {
            fetch(`http://localhost:5148/api/accounts/user/${userId}`)
                .then(res => res.json())
                .then(accounts => {
                    const tablo = document.getElementById('hesaplar-tablo');
                    tablo.querySelectorAll('tr:not(:first-child)').forEach(tr => tr.remove());
                    if (accounts.length === 0) {
                        let tr = document.createElement('tr');
                        let td = document.createElement('td');
                        td.colSpan = 3;
                        td.innerText = "Hesabınız yok.";
                        tr.appendChild(td);
                        tablo.appendChild(tr);
                    } else {
                        accounts.forEach(acc => {
                            let tr = document.createElement('tr');
                            tr.innerHTML = `
                              <td>${acc.accountNumber}</td>
                              <td>${acc.accountType}</td>
                              <td>${acc.balance}</td>
                            `;
                            tablo.appendChild(tr);
                        });
                    }
                })
                .catch(err => {
                    document.getElementById('uyari-mesaj').innerText = "Hesaplar yüklenemedi!";
                });
        }

        hesaplariYukle();

        document.getElementById('hesap-olustur-btn').addEventListener('click', function() {
            if (document.getElementById('yeni-hesap-tr')) return; 

            const tablo = document.getElementById('hesaplar-tablo');
            const tr = document.createElement('tr');
            tr.id = "yeni-hesap-tr";
            tr.innerHTML = `
              <td>Otomatik</td>
              <td>
                <select id="yeni-hesap-tur">
                  <option value="TL">TL</option>
                  <option value="USD">USD</option>
                  <option value="EUR">EUR</option>
                </select>
              </td>
              <td>
                <input type="number" min="0" id="yeni-hesap-balance" placeholder="Başlangıç Bakiye" style="width:100px;">
                <button id="hesap-kaydet-btn">Kaydet</button>
                <button id="hesap-iptal-btn">İptal</button>
              </td>
            `;
            tablo.appendChild(tr);
            document.getElementById('hesap-kaydet-btn').onclick = async function() {
                const accountType = document.getElementById('yeni-hesap-tur').value;
                const balance = document.getElementById('yeni-hesap-balance').value;
                if (!balance) {
                    document.getElementById('uyari-mesaj').innerText = "Lütfen bakiye gir!";
                    return;
                }
                if(balance >100000000) {
                    document.getElementById('uyari-mesaj').innerText = 
                    'Bakiye 100.000.000 ' + accountType + "’den fazla olamaz!";
                    return;
                }
                const response = await fetch('http://localhost:5148/api/accounts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: parseInt(userId),
                        accountType: accountType,
                        balance: parseFloat(balance)
                    })
                });
                if (response.ok) {
                    document.getElementById('uyari-mesaj').innerText = "✅ Hesap eklendi!";
                    hesaplariYukle();
                    tr.remove();
                } else {
                    const error = await response.text();
                    document.getElementById('uyari-mesaj').innerText = "❌ " + error;
                }
            };

            // İptal tuşu
            document.getElementById('hesap-iptal-btn').onclick = function() {
                tr.remove();
                document.getElementById('uyari-mesaj').innerText = "";
            };
        });
    });
    </script>
</body>
</html>
